<!-- templates/index.html -->
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Computer Use Agent</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <style>
            /* åŸºç¡€æ ·å¼ï¼šé»˜è®¤ä¸ºç”µè„‘ç«¯çš„å·¦å³å¸ƒå±€ */
            body,
            html {
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            #app-container {
                display: flex;
                height: 100vh;
            }
            #header {
                height: 50px;
                background-color: #f8f9fa;
                border-bottom: 1px solid #dee2e6;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 18px;
                position: sticky;
                top: 0;
                z-index: 1000;
                flex-shrink: 0;
            }
            #sidebar {
                width: 33.33%;
                display: flex;
                flex-direction: column;
                border-right: 1px solid #dee2e6;
                overflow: hidden;
            }
            #main-content {
                width: 66.66%;
                position: relative;
                overflow: hidden;
            }
            #video-container {
                width: 100%;
                height: 100%;
                background-color: #000;
            }
            #video-container img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            /* å…³é”®ä¿®å¤ï¼šç¡®ä¿ tab-content å’Œ chat tab çš„æ­£ç¡®å¸ƒå±€ */
            .tab-content {
                flex: 1;
                overflow: hidden; /* é‡è¦ï¼šè®©å­å…ƒç´ æ§åˆ¶æ»šåŠ¨ */
            }

            /* Chat tab éœ€è¦æ˜¯ flex å®¹å™¨ */

            #chat-content {
                flex: 1;
                overflow-y: auto;
                padding: 10px;
                display: flex;
                flex-direction: column;
            }

            /* å“åº”å¼è®¾è®¡ï¼šå½“å±å¹•å®½åº¦å°äº 768px æ—¶ï¼ˆæ‰‹æœºç«¯ï¼‰ï¼Œåˆ‡æ¢ä¸ºä¸Šä¸‹å¸ƒå±€ */
            @media (max-width: 768px) {
                #app-container {
                    flex-direction: column; /* æ”¹ä¸ºå‚ç›´æ’åˆ— */
                }
                #header {
                    height: 40px;
                    font-size: 16px;
                }
                #sidebar {
                    width: 100%; /* å æ®å…¨å®½ */
                    height: 67vh; /* å æ®ä¸Šé¢ 3/4 çš„é«˜åº¦ */
                    border-right: none;
                    border-bottom: 1px solid #dee2e6; /* åº•éƒ¨åŠ è¾¹æ¡†ï¼Œä¸å›¾åƒåŒºåˆ†å¼€ */
                }
                #main-content {
                    width: 100%;
                    height: 33vh; /* å æ®ä¸‹é¢ 1/4 çš„é«˜åº¦ */
                }
                #video-container {
                    height: 100%; /* å¡«æ»¡ #main-content çš„é«˜åº¦ */
                }
                #video-container img {
                    object-fit: cover; /* åœ¨æ‰‹æœºç«¯ä½¿ç”¨ coverï¼Œé¿å…é»‘è¾¹ï¼Œç¡®ä¿å¡«æ»¡ */
                }
            }

            .message-bubble {
                max-width: 80%;
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 15px;
                word-wrap: break-word;
            }
            .user-bubble {
                background-color: #dcf8c6;
                align-self: flex-end;
                margin-left: auto;
            }
            .llm-bubble {
                background-color: #e5e5ea;
                align-self: flex-start;
            }
            .screenshot-bubble {
                background-color: #f0f0f0;
                text-align: center;
            }
            .screenshot-bubble img {
                max-width: 100%;
                max-height: 200px;
                border: 1px solid #ccc;
            }
            #header-container {
                /* ä½¿ç”¨é›è“è‰²ä½œä¸ºèƒŒæ™¯ */
                background-color: #3f51b5;
                color: #fff; /* æ–‡æœ¬é¢œè‰²ä¸ºç™½è‰² */
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                position: sticky;
                left: 0;
                right: 0;
                top: 0;
                z-index: 4;

                box-shadow:
                    0 0 0.2rem #0000,
                    0 0.2rem 0.4rem #0000;
                transition:
                    background-color 0.25s,
                    transform 0.25s cubic-bezier(0.1, 0.7, 0.1, 1),
                    box-shadow 0.25s;
            }

            #header-container:hover {
                /* æ‚¬åœæ—¶æ˜¾ç¤ºé˜´å½± */
                box-shadow:
                    0 0 0.2rem rgba(0, 0, 0, 0.1),
                    0 0.2rem 0.4rem rgba(0, 0, 0, 0.2);
            }

            .header-title-text {
                font-size: 1.2em;
                font-weight: bold;
                /* å¦‚æœä½ å¼•å…¥äº†è‡ªå®šä¹‰å­—ä½“ï¼Œå¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨ */
                /* font-family: 'Oxanium', sans-serif; */
                color: var(--md-primary-bg-color);
            }

            /* Log tab æ ·å¼ */

            #log-content {
                white-space: pre-wrap;
                font-family: monospace;
                font-size: 12px;
                flex: 1;
                overflow-y: auto;
                padding: 10px;
            }

            /* Settings tab æ ·å¼ */
            #settings {
                height: 100%;
                overflow-y: auto;
                padding: 10px;
            }

            /* ä¿®æ”¹tab-contentçš„æ ·å¼ */
            .tab-content {
                flex: 1;
                overflow: hidden;
                display: flex; /* æ·»åŠ flexå¸ƒå±€ */
                flex-direction: column; /* å‚ç›´æ–¹å‘æ’åˆ— */
            }

            /* ç¡®ä¿æ¯ä¸ªtab-paneéƒ½æ­£ç¡®æ˜¾ç¤º */
            .tab-pane {
                display: none; /* Bootstrapé»˜è®¤éšè— */
                height: 100%; /* å æ®å…¨éƒ¨é«˜åº¦ */
                flex-direction: column; /* å‚ç›´å¸ƒå±€ */
            }

            .tab-pane.active {
                display: flex; /* æ¿€æ´»çš„tabæ˜¾ç¤ºä¸ºflex */
            }

            .input-group {
                padding: 10px;
                background-color: #f8f9fa;
                border-top: 1px solid #dee2e6;
                flex-shrink: 0; /* é˜²æ­¢è¾“å…¥æ¡†è¢«å‹ç¼© */
            }
        </style>
    </head>
    <body>
        <div id="app-container">
            <!-- ä¾§è¾¹æ ï¼šäº¤äº’ã€æ—¥å¿—ã€è®¾ç½® -->
            <div id="sidebar">
                <div id="header-container" class="md-header">
                    <span class="header-title-text"
                        >ğŸ’» NanoKVM Computer Use Agent âœ¨</span
                    >
                </div>
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link active"
                            id="chat-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#chat"
                            type="button"
                            role="tab"
                        >
                            Chat
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link"
                            id="log-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#log"
                            type="button"
                            role="tab"
                        >
                            Log
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link"
                            id="settings-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#settings"
                            type="button"
                            role="tab"
                        >
                            Setting
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <!-- Chat Tab -->
                    <div
                        class="tab-pane fade show active"
                        id="chat"
                        role="tabpanel"
                    >
                        <div id="chat-content">
                            <!-- èŠå¤©æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
                        </div>
                        <div class="input-group">
                            <input
                                type="text"
                                class="form-control"
                                id="user-input"
                                placeholder="Enter your task or message..."
                            />
                            <button
                                class="btn btn-outline-secondary"
                                type="button"
                                id="action-btn"
                            >
                                Send
                            </button>
                            <button
                                class="btn btn-outline-danger"
                                type="button"
                                id="reset-btn"
                            >
                                Reset
                            </button>
                        </div>
                    </div>

                    <!-- Log Tab -->
                    <div class="tab-pane fade" id="log" role="tabpanel">
                        <pre id="log-content"></pre>
                    </div>

                    <!-- Settings Tab -->
                    <div class="tab-pane fade" id="settings" role="tabpanel">
                        <div style="padding: 10px">
                            <form id="settings-form">
                                <div class="mb-3">
                                    <label for="api-key" class="form-label"
                                        >API Key</label
                                    >
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="api-key"
                                        placeholder="Enter API Key"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="base-url" class="form-label"
                                        >Base URL</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="base-url"
                                        placeholder="https://..."
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="model-name" class="form-label"
                                        >Model Name</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="model-name"
                                        placeholder="e.g., qwen-vl-max-2025-08-13"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="img-keep-n" class="form-label"
                                        >IMG_KEEP_N</label
                                    >
                                    <input
                                        type="number"
                                        class="form-control"
                                        id="img-keep-n"
                                        placeholder="3"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="max-rounds" class="form-label"
                                        >MAX_ROUNDS</label
                                    >
                                    <input
                                        type="number"
                                        class="form-control"
                                        id="max-rounds"
                                        placeholder="20"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label
                                        for="initial-prompt"
                                        class="form-label"
                                        >Initial Prompt</label
                                    >
                                    <textarea
                                        class="form-control"
                                        id="initial-prompt"
                                        rows="5"
                                    ></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    Submit
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒºï¼šæ˜¾ç¤ºæ¡Œé¢ -->
            <div id="main-content">
                <div id="video-container">
                    <img
                        id="desktop-snapshot"
                        src="/desktop-snapshot"
                        alt="Desktop Stream"
                    />
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
        <script>
            const socket = io();
            let isTaskRunning = false;
            let currentTaskId = null;
            window.addEventListener("unload", () => {
                fetch("/api/assistant_stop", {
                    method: "GET",
                })
                    .then((res) => res.json())
                    .then((data) => {
                        console.log(data);
                    });
            });
            // é¡µé¢åŠ è½½å®Œæˆåï¼Œè·å–å½“å‰è®¾ç½®
            document.addEventListener("DOMContentLoaded", function () {
                loadSettings();
                setupEventListeners();
            });

            function loadSettings() {
                fetch("/settings")
                    .then((response) => response.json())
                    .then((data) => {
                        document.getElementById("api-key").value = data.api_key;
                        document.getElementById("base-url").value =
                            data.base_url;
                        document.getElementById("model-name").value =
                            data.model_name;
                        document.getElementById("img-keep-n").value =
                            data.img_keep_n;
                        document.getElementById("max-rounds").value =
                            data.max_rounds;
                        document.getElementById("initial-prompt").value =
                            data.initial_prompt;
                    });
            }

            function setupEventListeners() {
                // è®¾ç½®è¡¨å•æäº¤
                document
                    .getElementById("settings-form")
                    .addEventListener("submit", function (e) {
                        e.preventDefault();
                        const settings = {
                            api_key: document.getElementById("api-key").value,
                            base_url: document.getElementById("base-url").value,
                            model_name:
                                document.getElementById("model-name").value,
                            img_keep_n:
                                document.getElementById("img-keep-n").value,
                            max_rounds:
                                document.getElementById("max-rounds").value,
                            initial_prompt:
                                document.getElementById("initial-prompt").value,
                        };
                        fetch("/settings", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(settings),
                        })
                            .then((response) => response.json())
                            .then((data) => {
                                alert(data.message);
                            });
                    });

                // å‘é€/æš‚åœæŒ‰é’®
                const actionBtn = document.getElementById("action-btn");
                const userInput = document.getElementById("user-input");
                actionBtn.addEventListener("click", function () {
                    const text = userInput.value.trim();
                    if (!text && actionBtn.innerText === "Send") return;

                    if (!isTaskRunning) {
                        // å¼€å§‹æ–°ä»»åŠ¡
                        startNewTask(text);
                        // ç«‹å³æ›´æ–°æŒ‰é’®æ–‡æœ¬ä¸º"æš‚åœ"ï¼Œå› ä¸ºä»»åŠ¡å·²å¯åŠ¨
                        actionBtn.innerText = "Pause";
                    } else {
                        // ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œç‚¹å‡»æŒ‰é’®æ˜¯"æš‚åœ"
                        if (actionBtn.innerText === "Pause") {
                            pauseTask(); // è°ƒç”¨æš‚åœå‡½æ•°
                            // æŒ‰é’®æ–‡æœ¬æš‚æ—¶ä¸å˜ï¼Œç­‰åç«¯ç¡®è®¤æš‚åœåå†æ›´æ–°
                        } else if (actionBtn.innerText === "Send") {
                            // æŒ‰é’®æ˜¯"å‘é€"ï¼Œè¯´æ˜ä»»åŠ¡å¤„äºæš‚åœæˆ–ç­‰å¾…ç”¨æˆ·è¾“å…¥çŠ¶æ€ï¼Œæ­¤æ—¶å‘é€ç”¨æˆ·è¾“å…¥
                            resumeAndSendInput(text);
                        }
                    }
                });

                // é‡ç½®æŒ‰é’®
                document
                    .getElementById("reset-btn")
                    .addEventListener("click", function () {
                        if (confirm("Confirm Reset Task?")) {
                            fetch("/reset_task", { method: "POST" })
                                .then((response) => response.json())
                                .then((data) => {
                                    if (data.status === "success") {
                                        isTaskRunning = false;
                                        currentTaskId = null;
                                        document.getElementById(
                                            "chat-content",
                                        ).innerHTML = "";
                                        document.getElementById(
                                            "log-content",
                                        ).innerText = "";
                                        userInput.value = "";
                                        actionBtn.innerText = "Send";
                                        alert("ä»»åŠ¡å·²é‡ç½®");
                                    }
                                });
                        }
                    });

                // æ¥æ”¶ä»»åŠ¡æ›´æ–°
                socket.on("task_update", function (data) {
                    updateUI(data);
                });

                // å›è½¦é”®å‘é€æ¶ˆæ¯
                userInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        actionBtn.click();
                    }
                });
            }

            function pauseTask() {
                fetch("/pause_task", { method: "POST" })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.status === "success") {
                            // æš‚åœæˆåŠŸï¼Œæ›´æ–°æŒ‰é’®æ–‡æœ¬
                            document.getElementById("action-btn").innerText =
                                "Send";
                            // å¯é€‰ï¼šç»™ç”¨æˆ·ä¸€ä¸ªè§†è§‰åé¦ˆ
                            appendLLMMessage(
                                "â¸ï¸ Task Paused, waiting for your input...",
                            );
                        } else {
                            alert("æš‚åœå¤±è´¥: " + data.message);
                        }
                    });
            }

            function resumeAndSendInput(userInputText) {
                fetch("/resume_task", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ user_input: userInputText }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.status === "success") {
                            // å°†ç”¨æˆ·è¾“å…¥æ˜¾ç¤ºåœ¨èŠå¤©çª—å£
                            appendUserMessage(userInputText);
                            document.getElementById("user-input").value = "";
                            // ä»»åŠ¡æ¢å¤è¿è¡Œï¼ŒæŒ‰é’®å˜å›"æš‚åœ"
                            document.getElementById("action-btn").innerText =
                                "Pause";
                        }
                    });
            }

            function startNewTask(taskDesc) {
                fetch("/start_task", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ task_desc: taskDesc }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.status === "success") {
                            isTaskRunning = true;
                            document.getElementById("action-btn").innerText =
                                "Pause";
                            // å°†ç”¨æˆ·è¾“å…¥æ˜¾ç¤ºåœ¨èŠå¤©çª—å£
                            appendUserMessage(taskDesc);
                            document.getElementById("user-input").value = "";
                        } else {
                            document.getElementById("user-input").value = "";
                            alert(data.message);
                        }
                    });
            }

            function pauseAndSendInput(userInputText) {
                fetch("/pause_task", { method: "POST" })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.status === "success") {
                            // ç„¶åç«‹å³æ¢å¤å¹¶å‘é€è¾“å…¥
                            fetch("/resume_task", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    user_input: userInputText,
                                }),
                            })
                                .then((response) => response.json())
                                .then((data) => {
                                    if (data.status === "success") {
                                        isTaskRunning = true;
                                        actionBtn.innerText = "Pause";
                                        // å°†ç”¨æˆ·è¾“å…¥æ˜¾ç¤ºåœ¨èŠå¤©çª—å£
                                        appendUserMessage(userInputText);
                                        userInput.value = "";
                                    }
                                });
                        }
                    });
            }

            // æ»šåŠ¨åˆ°åº•éƒ¨çš„å‡½æ•° - ç®€å•æœ‰æ•ˆçš„ç‰ˆæœ¬
            function scrollChatToBottom() {
                const chatContent = document.getElementById("chat-content");
                //console.log('Scrolling to bottom, scrollHeight:', chatContent.scrollHeight); // è°ƒè¯•ç”¨
                chatContent.scrollTop = chatContent.scrollHeight;
            }

            function appendUserMessage(text) {
                const chatContent = document.getElementById("chat-content");
                const bubble = document.createElement("div");
                bubble.className = "message-bubble user-bubble";
                bubble.innerText = text;
                chatContent.appendChild(bubble);
                // ç«‹å³æ»šåŠ¨
                scrollChatToBottom();
            }

            function appendLLMMessage(text) {
                const chatContent = document.getElementById("chat-content");
                const bubble = document.createElement("div");
                bubble.className = "message-bubble llm-bubble";
                bubble.innerText = text;
                chatContent.appendChild(bubble);
                // ç«‹å³æ»šåŠ¨
                scrollChatToBottom();
            }

            function appendScreenshot(imgBase64) {
                const chatContent = document.getElementById("chat-content");
                const bubble = document.createElement("div");
                bubble.className = "message-bubble screenshot-bubble";
                const img = document.createElement("img");
                img.src = "data:image/jpeg;base64," + imgBase64;

                bubble.appendChild(img);
                chatContent.appendChild(bubble);

                // ç«‹å³å°è¯•æ»šåŠ¨
                scrollChatToBottom();

                // å›¾ç‰‡åŠ è½½å®Œæˆåå†æ¬¡æ»šåŠ¨ï¼ˆå›¾ç‰‡åŠ è½½ä¼šæ”¹å˜é«˜åº¦ï¼‰
                img.onload = function () {
                    scrollChatToBottom();
                };
            }

            function updateUI(data) {
                // æ›´æ–°æ—¥å¿—
                const logContent = document.getElementById("log-content");

                // å°†çº¯æ–‡æœ¬çš„æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLçš„<br>æ ‡ç­¾
                let formattedLog = (data.log || "").replace(/\n/g, "<br>");

                // ä½¿ç”¨ innerHTML è€Œä¸æ˜¯ innerText
                logContent.innerHTML += formattedLog + "<br><br>";

                // æ—¥å¿—æ»šåŠ¨åˆ°åº•éƒ¨
                logContent.scrollTop = logContent.scrollHeight;

                if (data.status === "done" || data.status === "error") {
                    isTaskRunning = false;
                    document.getElementById("action-btn").innerText = "Send";
                    if (data.status === "done") {
                        appendLLMMessage("âœ… Task Doneï¼");
                    } else {
                        appendLLMMessage("âŒ Task Failed: " + data.log);
                    }
                } else if (
                    data.status === "running" ||
                    data.status === "paused" ||
                    data.status === "waiting_for_user"
                ) {
                    // æ˜¾ç¤ºæˆªå›¾
                    if (data.screenshot_base64) {
                        appendScreenshot(data.screenshot_base64);
                    }
                    // æ˜¾ç¤ºLLMçš„æ€è€ƒ
                    if (data.llm_thoughts && data.llm_thoughts.length > 0) {
                        data.llm_thoughts.forEach((thought) => {
                            appendLLMMessage("# " + thought);
                        });
                    }
                    // æ˜¾ç¤ºæ‰§è¡Œçš„å‘½ä»¤
                    if (data.executed_command) {
                        appendLLMMessage("â¡ï¸ " + data.executed_command);
                    }
                    // åˆ›å»ºä¸€ä¸ªé†’ç›®çš„é”™è¯¯æ¶ˆæ¯æ°”æ³¡
                    if (data.error_message) {
                        const chatContent =
                            document.getElementById("chat-content");
                        const errorBubble = document.createElement("div");
                        errorBubble.className = "message-bubble llm-bubble";
                        errorBubble.style.backgroundColor = "#ffebee"; // æµ…çº¢è‰²èƒŒæ™¯
                        errorBubble.style.color = "#c62828"; // æ·±çº¢è‰²æ–‡å­—
                        errorBubble.style.border = "1px solid #ef9a9a";
                        errorBubble.innerHTML = `<strong>âš ï¸ Error</strong><br>${data.error_message}`;
                        chatContent.appendChild(errorBubble);
                        scrollChatToBottom();
                    }

                    // å¦‚æœæ˜¯ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œè‡ªåŠ¨å°†æŒ‰é’®æ”¹ä¸º"å‘é€"
                    if (
                        data.status === "waiting_for_user" ||
                        data.status === "paused"
                    ) {
                        document.getElementById("action-btn").innerText =
                            "Send";
                    }
                }
            }
        </script>
    </body>
</html>
